name: API Tests

on: [push, pull_request]

jobs:
  run-api-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Repository ophalen
      uses: actions/checkout@v3

    - name: Dependencies installeren
      run: npm install

    - name: Toon bestanden voor debugging
      run: ls -R

    - name: Controleer of de collectie en environment bestaan
      run: |
        if [ ! -f collections/regression_testing.postman_collection.json ]; then
          echo "❌ Collection file ontbreekt!"
          exit 1
        fi
        if [ ! -f environments/rijks.postman_environment.json ]; then
          echo "❌ Environment file ontbreekt!"
          exit 1
        fi

    - name: API-tests draaien met Newman
      run: |
        npx newman run collections/regression_testing.postman_collection.json \
          -e environments/rijks.postman_environment.json \
          --env-var "key=${{ secrets.KEY }}" \
          -r cli,htmlextra \
          --reporter-htmlextra-export reports/test-report.html \
          --verbose

    - name: Upload rapport
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: newman-report
        path: reports/test-report.html
